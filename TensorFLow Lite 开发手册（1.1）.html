<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TensorFLow Lite 开发手册（1.1）</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><p></p><div class="toc"><h3>TensorFLow Lite 开发手册（1.1）</h3><ul><li><a href="#0__2">0 独家鸣谢</a></li><li><a href="#1__5">1 开发环境（已测试）</a></li><li><a href="#2_TensorFlow_20_15">2 TensorFlow 2.0安装与使用</a></li><ul><li><a href="#21_TensorFlow_20_16">2.1 TensorFlow 2.0安装</a></li><li><a href="#22_TensorFlow_20__30">2.2 TensorFlow 2.0 新特性简介</a></li><li><a href="#23__51">2.3 训练模型的一般流程</a></li><li><a href="#24__158">2.4 训练示例模型</a></li><li><a href="#25__194">2.5 模型转换</a></li><ul><li><a href="#251__195">2.5.1 模型转换方法</a></li><li><a href="#252__203">2.5.2 转换示例模型</a></li></ul><li><a href="#26__213">2.6 模型调用</a></li><ul><li><a href="#261_Python__214">2.6.1 Python 接口</a></li><li><a href="#262_C_251">2.6.2 C++接口</a></li></ul></ul><li><a href="#3_TensorFlow_Lite_273">3 安装TensorFlow Lite</a></li><ul><li><a href="#31__274">3.1 平台支持</a></li><li><a href="#32__279">3.2 下载源代码</a></li><li><a href="#33__289">3.3 安装依赖库</a></li><ul><li><a href="#331__290">3.3.1 安装工具链</a></li><li><a href="#332__294">3.3.2 安装依赖库</a></li></ul><li><a href="#34_TensorFlow_Lite_298">3.4 编译TensorFlow Lite</a></li></ul><li><a href="#4_TensorFlow_Lite_318">4 TensorFlow Lite模型使用实例（分类模型）</a></li><ul><li><a href="#41_CLion_319">4.1 新建CLion工程</a></li><li><a href="#42_Cmakelist_323">4.2 编写Cmakelist</a></li><li><a href="#43_maincpp_338">4.3 编写main.cpp</a></li><li><a href="#44__672">4.4 下载预训练模型</a></li><li><a href="#45__682">4.5 修改模型配置</a></li><li><a href="#46__707">4.6 运行实例</a></li></ul><li><a href="#5_TensorFlow_LiteCPM_722">5 TensorFlow Lite模型使用通用流程（以CPM算法为例）</a></li><ul><li><a href="#51__723">5.1 流程示意</a></li><li><a href="#52__735">5.2 主要函数说明</a></li><li><a href="#53__747">5.3 操作流程</a></li><ul><li><a href="#531_CPM_748">5.3.1 CPM算法介绍</a></li><li><a href="#532__753">5.3.2 加载模型</a></li><li><a href="#533_tensor_786">5.3.3 加载所有tensor</a></li><li><a href="#534__795">5.3.4 获取输入输出信息</a></li><li><a href="#535__806">5.3.5 构建输入</a></li><li><a href="#536__832">5.3.6 调用模型</a></li><li><a href="#537__850">5.3.7 取出输出结果</a></li><li><a href="#538__869">5.3.8 输出结果后处理</a></li><li><a href="#538__905">5.3.8 标记结果</a></li><li><a href="#539__908">5.3.9 完整程序</a></li></ul></ul></ul></div><p></p>
<h1><a id="0__2"></a>0 独家鸣谢</h1>
<p>独家感谢<strong>庆喜哥</strong>、<strong>苏睿哥</strong>在C++部分提供的不可或缺的帮助！！！</p>
<h1><a id="1__5"></a>1 开发环境（已测试）</h1>

<table>
<thead>
<tr>
<th align="center">TensorFlow 版本</th>
<th align="center">2.0（stable）</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>开发平台</strong></td>
<td align="center">Ubuntu 18.04 LTS</td>
</tr>
<tr>
<td align="center"><strong>Python 版本</strong></td>
<td align="center">3.6</td>
</tr>
<tr>
<td align="center"><strong>gcc</strong></td>
<td align="center">gcc (Ubuntu 7.4.0-1ubuntu1~18.04.1) 7.4.0</td>
</tr>
<tr>
<td align="center"><strong>g++</strong></td>
<td align="center">g++ (Ubuntu 7.4.0-1ubuntu1~18.04.1) 7.4.0</td>
</tr>
<tr>
<td align="center"><strong>cmake</strong></td>
<td align="center">cmake version 3.10.2</td>
</tr>
<tr>
<td align="center"><strong>opencv</strong></td>
<td align="center">3.2.0</td>
</tr>
</tbody>
</table><h1><a id="2_TensorFlow_20_15"></a>2 TensorFlow 2.0安装与使用</h1>
<h2><a id="21_TensorFlow_20_16"></a>2.1 TensorFlow 2.0安装</h2>
<p>创建虚拟环境：</p>
<pre><code>conda create --name py36-tf20 python=3.6
conda activate py36-tf20
</code></pre>
<p>目前conda源已维护至2.0版本，可以使用conda命令安装：</p>
<pre><code># 安装CPU版本
conda install tensorflow==2.0.0

# 安装GPU版本，CUDA支持请查看TensoFlow官网
conda install tensorflow-gpu==2.0.0
</code></pre>
<h2><a id="22_TensorFlow_20__30"></a>2.2 TensorFlow 2.0 新特性简介</h2>
<ul>
<li>
<p><strong>API Cleanup</strong><br>
移除了许多库，如<strong>tf.app，tf.logging，tf.flags</strong>等，将原有的函数库整合进了<strong>tf.keras</strong>，如<strong>tf.layers-&gt;tf.keras.layers</strong></p>
</li>
<li>
<p><strong>Eager execution</strong><br>
在2.0中，动态图机制成为默认机制，不再需要用户手动创建会话，也不需要使用 <strong>sess.run()</strong> 来指定输入输出的张量。</p>
</li>
<li>
<p><strong>No more globals</strong><br>
不再依赖隐式全局命名空间，即不再依赖tf.Variable()来声明变量，而是采用默认机制：“ Keep track of your variables!”，如果不再追溯某个tf.Variable，其就会被回收。</p>
</li>
<li>
<p><strong>Functions, not sessions</strong>（个人认为是很重要、也很厉害的一点）<br>
在2.0中提供了名为 <strong>@tf.function()</strong> 的装饰器，它可以对普通的Python函数进行标记以进行JIT编译，然后TensorFlow就可以将其作为单一的计算图来运行，这使得该函数<strong>可以直接被优化</strong>和<strong>作为模型导出</strong>。并且为了帮助用户在添加**@tf.function<strong>时避免重写代码，<strong>AutoGraph</strong>将python中的一些函数转换为其</strong>TensorFlow**包含的等价函数：</p>
</li>
</ul>
<pre><code class="prism language-python">  <span class="token keyword">for</span><span class="token operator">/</span><span class="token keyword">while</span> <span class="token operator">-</span><span class="token operator">&gt;</span> tf<span class="token punctuation">.</span>while_loop <span class="token punctuation">(</span><span class="token keyword">break</span> <span class="token operator">and</span> <span class="token keyword">continue</span> are supported<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token operator">-</span><span class="token operator">&gt;</span> tf<span class="token punctuation">.</span>cond
  <span class="token keyword">for</span> _ <span class="token keyword">in</span> dataset <span class="token operator">-</span><span class="token operator">&gt;</span> dataset<span class="token punctuation">.</span><span class="token builtin">reduce</span>
</code></pre>
<ul>
<li>个人补充<br>
在2.0中，<strong>Keras</strong>被全面整合，<strong>Google</strong>也推荐大家使用<strong>tf.keras</strong>更高效构建模型，并且使用<strong>tf.data</strong>构建数据流（有关<strong>tf.data</strong>使用的流程可以参照我的博客<a href="https://blog.csdn.net/weixin_42499236/article/category/8331677">https://blog.csdn.net/weixin_42499236/article/category/8331677</a>），而<strong>tf.keras</strong>保存的模型也可以直接被转换为<strong>TensorFlow Lite</strong>模型，所以还是用<strong>Keras</strong>比较好。</li>
</ul>
<h2><a id="23__51"></a>2.3 训练模型的一般流程</h2>
<p>训练模型的基本流程如下：</p>
<ul>
<li>将 Tensorflow 导入程序：</li>
</ul>
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>layers <span class="token keyword">import</span> Dense<span class="token punctuation">,</span> Flatten<span class="token punctuation">,</span> Conv2D
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> Model
</code></pre>
<ul>
<li>加载数据</li>
</ul>
<pre><code class="prism language-python">mnist <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>mnist

<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span> <span class="token operator">=</span> mnist<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
x_train<span class="token punctuation">,</span> x_test <span class="token operator">=</span> x_train <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">,</span> x_test <span class="token operator">/</span> <span class="token number">255.0</span>

<span class="token comment"># Add a channels dimension</span>
x_train <span class="token operator">=</span> x_train<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
x_test <span class="token operator">=</span> x_test<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>newaxis<span class="token punctuation">]</span>
</code></pre>
<ul>
<li>使用 tf.data 来将数据集切分为 batch 以及shuffle数据集：</li>
</ul>
<pre><code class="prism language-python">train_ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>from_tensor_slices<span class="token punctuation">(</span>
    <span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">.</span>batch<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
test_ds <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>from_tensor_slices<span class="token punctuation">(</span><span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>batch<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>使用 Keras 模型子类化（model subclassing） API 构建 tf.keras 模型：</li>
</ul>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">MyModel</span><span class="token punctuation">(</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">super</span><span class="token punctuation">(</span>MyModel<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> Conv2D<span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>flatten <span class="token operator">=</span> Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>d1 <span class="token operator">=</span> Dense<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>d2 <span class="token operator">=</span> Dense<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span>

  <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span>d1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
    <span class="token keyword">return</span> self<span class="token punctuation">.</span>d2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

model <span class="token operator">=</span> MyModel<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>为训练选择优化器与损失函数：</li>
</ul>
<pre><code class="prism language-python">loss_object <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>SparseCategoricalCrossentropy<span class="token punctuation">(</span><span class="token punctuation">)</span>

optimizer <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>选择衡量指标来度量模型的损失值（loss）和准确率（accuracy）。这些指标在 epoch 上累积值，然后打印出整体结果。</li>
</ul>
<pre><code class="prism language-python">train_loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>Mean<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'train_loss'</span><span class="token punctuation">)</span>
train_accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>SparseCategoricalAccuracy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'train_accuracy'</span><span class="token punctuation">)</span>

test_loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>Mean<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'test_loss'</span><span class="token punctuation">)</span>
test_accuracy <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>metrics<span class="token punctuation">.</span>SparseCategoricalAccuracy<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">'test_accuracy'</span><span class="token punctuation">)</span>
</code></pre>
<ul>
<li>使用 tf.GradientTape 来训练模型：</li>
</ul>
<pre><code class="prism language-python">@tf<span class="token punctuation">.</span>function
<span class="token keyword">def</span> <span class="token function">train_step</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">with</span> tf<span class="token punctuation">.</span>GradientTape<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tape<span class="token punctuation">:</span>
    predictions <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
    loss <span class="token operator">=</span> loss_object<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
  gradients <span class="token operator">=</span> tape<span class="token punctuation">.</span>gradient<span class="token punctuation">(</span>loss<span class="token punctuation">,</span> model<span class="token punctuation">.</span>trainable_variables<span class="token punctuation">)</span>
  optimizer<span class="token punctuation">.</span>apply_gradients<span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>gradients<span class="token punctuation">,</span> model<span class="token punctuation">.</span>trainable_variables<span class="token punctuation">)</span><span class="token punctuation">)</span>

  train_loss<span class="token punctuation">(</span>loss<span class="token punctuation">)</span>
  train_accuracy<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
</code></pre>
<ul>
<li>测试模型：</li>
</ul>
<pre><code class="prism language-python">@tf<span class="token punctuation">.</span>function
<span class="token keyword">def</span> <span class="token function">test_step</span><span class="token punctuation">(</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">:</span>
  predictions <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
  t_loss <span class="token operator">=</span> loss_object<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>

  test_loss<span class="token punctuation">(</span>t_loss<span class="token punctuation">)</span>
  test_accuracy<span class="token punctuation">(</span>labels<span class="token punctuation">,</span> predictions<span class="token punctuation">)</span>
EPOCHS <span class="token operator">=</span> <span class="token number">5</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>EPOCHS<span class="token punctuation">)</span><span class="token punctuation">:</span>
  <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> train_ds<span class="token punctuation">:</span>
    train_step<span class="token punctuation">(</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>

  <span class="token keyword">for</span> test_images<span class="token punctuation">,</span> test_labels <span class="token keyword">in</span> test_ds<span class="token punctuation">:</span>
    test_step<span class="token punctuation">(</span>test_images<span class="token punctuation">,</span> test_labels<span class="token punctuation">)</span>

  template <span class="token operator">=</span> <span class="token string">'Epoch {}, Loss: {}, Accuracy: {}, Test Loss: {}, Test Accuracy: {}'</span>
  <span class="token keyword">print</span> <span class="token punctuation">(</span>template<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>
                         train_loss<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         train_accuracy<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">,</span>
                         test_loss<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         test_accuracy<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  
</code></pre>
<ul>
<li>输出如下：</li>
</ul>
<pre><code class="prism language-python">Epoch <span class="token number">1</span><span class="token punctuation">,</span> Loss<span class="token punctuation">:</span> <span class="token number">0.13822732865810394</span><span class="token punctuation">,</span> Accuracy<span class="token punctuation">:</span> <span class="token number">95.84833526611328</span><span class="token punctuation">,</span> Test Loss<span class="token punctuation">:</span> <span class="token number">0.07067110389471054</span><span class="token punctuation">,</span> Test Accuracy<span class="token punctuation">:</span> <span class="token number">97.75</span>
Epoch <span class="token number">2</span><span class="token punctuation">,</span> Loss<span class="token punctuation">:</span> <span class="token number">0.09080979228019714</span><span class="token punctuation">,</span> Accuracy<span class="token punctuation">:</span> <span class="token number">97.25</span><span class="token punctuation">,</span> Test Loss<span class="token punctuation">:</span> <span class="token number">0.06446609646081924</span><span class="token punctuation">,</span> Test Accuracy<span class="token punctuation">:</span> <span class="token number">97.95999908447266</span>
Epoch <span class="token number">3</span><span class="token punctuation">,</span> Loss<span class="token punctuation">:</span> <span class="token number">0.06777264922857285</span><span class="token punctuation">,</span> Accuracy<span class="token punctuation">:</span> <span class="token number">97.93944549560547</span><span class="token punctuation">,</span> Test Loss<span class="token punctuation">:</span> <span class="token number">0.06325332075357437</span><span class="token punctuation">,</span> Test Accuracy<span class="token punctuation">:</span> <span class="token number">98.04000091552734</span>
Epoch <span class="token number">4</span><span class="token punctuation">,</span> Loss<span class="token punctuation">:</span> <span class="token number">0.054447807371616364</span><span class="token punctuation">,</span> Accuracy<span class="token punctuation">:</span> <span class="token number">98.33999633789062</span><span class="token punctuation">,</span> Test Loss<span class="token punctuation">:</span> <span class="token number">0.06611879169940948</span><span class="token punctuation">,</span> Test Accuracy<span class="token punctuation">:</span> <span class="token number">98.00749969482422</span>
Epoch <span class="token number">5</span><span class="token punctuation">,</span> Loss<span class="token punctuation">:</span> <span class="token number">0.04556874558329582</span><span class="token punctuation">,</span> Accuracy<span class="token punctuation">:</span> <span class="token number">98.60433197021484</span><span class="token punctuation">,</span> Test Loss<span class="token punctuation">:</span> <span class="token number">0.06510476022958755</span><span class="token punctuation">,</span> Test Accuracy<span class="token punctuation">:</span> <span class="token number">98.10400390625</span>
</code></pre>
<h2><a id="24__158"></a>2.4 训练示例模型</h2>
<p>基于以下代码训练示例模型，并得到模型文件<strong>model.h5</strong>：</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf
<span class="token keyword">from</span> tensorflow <span class="token keyword">import</span> keras

<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span> <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span>mnist<span class="token punctuation">.</span>load_data<span class="token punctuation">(</span><span class="token punctuation">)</span>
x_train <span class="token operator">=</span> tf<span class="token punctuation">.</span>expand_dims<span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
y_train <span class="token operator">=</span> keras<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>to_categorical<span class="token punctuation">(</span>y_train<span class="token punctuation">,</span> num_classes<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
datasets <span class="token operator">=</span> tf<span class="token punctuation">.</span>data<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>from_tensor_slices<span class="token punctuation">(</span><span class="token punctuation">(</span>x_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">)</span>
datasets <span class="token operator">=</span> datasets<span class="token punctuation">.</span>repeat<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>batch<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>

img <span class="token operator">=</span> keras<span class="token punctuation">.</span>Input<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>filters<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">,</span>activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>AveragePooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Conv2D<span class="token punctuation">(</span>filters<span class="token operator">=</span><span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>strides<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">,</span>activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>img<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>MaxPooling2D<span class="token punctuation">(</span>pool_size<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> strides<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token string">'SAME'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>BatchNormalization<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span><span class="token number">0.15</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Flatten<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
x <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'relu'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
y_pred <span class="token operator">=</span> keras<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>Dense<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> activation<span class="token operator">=</span><span class="token string">'softmax'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

model <span class="token operator">=</span> keras<span class="token punctuation">.</span>Model<span class="token punctuation">(</span>inputs<span class="token operator">=</span>img<span class="token punctuation">,</span> outputs<span class="token operator">=</span>y_pred<span class="token punctuation">)</span>
model<span class="token punctuation">.</span><span class="token builtin">compile</span><span class="token punctuation">(</span>optimizer<span class="token operator">=</span> keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             loss<span class="token operator">=</span> keras<span class="token punctuation">.</span>losses<span class="token punctuation">.</span>categorical_crossentropy<span class="token punctuation">,</span>
             metrics <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'AUC'</span><span class="token punctuation">,</span> <span class="token string">'accuracy'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>datasets<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'/home/ai/model.h5'</span><span class="token punctuation">)</span>
</code></pre>
<h2><a id="25__194"></a>2.5 模型转换</h2>
<h3><a id="251__195"></a>2.5.1 模型转换方法</h3>
<p>基本工作流程如下：<br>
<img src="https://img-blog.csdnimg.cn/20191021190339639.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQ5OTIzNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>
<strong>TensorFlow Lite</strong> 提供以下三种模型转换方法：</p>
<ul>
<li>tf.lite.TFLiteConverter.from_keras_model()，转换实例化的<strong>Keras</strong>模型</li>
<li>tf.lite.TFLiteConverter.from_saved_model()，转换<strong>pb</strong>文件</li>
<li>tf.lite.TFLiteConverter.from_concrete_functions()，转换<strong>具体的函数</strong></li>
</ul>
<h3><a id="252__203"></a>2.5.2 转换示例模型</h3>
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token comment"># 转换模型。</span>
converter <span class="token operator">=</span> tf<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>TFLiteConverter<span class="token punctuation">.</span>from_keras_model<span class="token punctuation">(</span>model<span class="token punctuation">)</span>
tflite_model <span class="token operator">=</span> converter<span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'/home/ai/converted_model.tflite'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>tflite_model<span class="token punctuation">)</span>
</code></pre>
<p>最终得到转化后的模型——<strong>converted_model.tflite</strong></p>
<h2><a id="26__213"></a>2.6 模型调用</h2>
<h3><a id="261_Python__214"></a>2.6.1 Python 接口</h3>
<pre><code class="prism language-python"><span class="token comment"># 加载 TFLite 模型并分配张量（tensor）。</span>
interpreter <span class="token operator">=</span> tf<span class="token punctuation">.</span>lite<span class="token punctuation">.</span>Interpreter<span class="token punctuation">(</span>model_content<span class="token operator">=</span>tflite_model<span class="token punctuation">)</span>
interpreter<span class="token punctuation">.</span>allocate_tensors<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 获取输入和输出张量。</span>
input_details <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_input_details<span class="token punctuation">(</span><span class="token punctuation">)</span>
output_details <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_output_details<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 使用随机数据作为输入测试 TensorFlow Lite 模型。</span>
input_shape <span class="token operator">=</span> input_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'shape'</span><span class="token punctuation">]</span>
input_data <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random_sample<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
interpreter<span class="token punctuation">.</span>set_tensor<span class="token punctuation">(</span>input_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> input_data<span class="token punctuation">)</span>

interpreter<span class="token punctuation">.</span>invoke<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 函数 `get_tensor()` 会返回一份张量的拷贝。</span>
<span class="token comment"># 使用 `tensor()` 获取指向张量的指针。</span>
tflite_results <span class="token operator">=</span> interpreter<span class="token punctuation">.</span>get_tensor<span class="token punctuation">(</span>output_details<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'index'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 使用随机数据作为输入测试 TensorFlow 模型。</span>
tf_results <span class="token operator">=</span> model<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>input_data<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tflite result:"</span><span class="token punctuation">,</span> tflite_results<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"tf result:"</span><span class="token punctuation">,</span> tf_results<span class="token punctuation">)</span>
</code></pre>
<p>输出结果如下：</p>
<pre><code class="prism language-python">tflite result<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2.80235346e-09</span> <span class="token number">9.99904633e-01</span> <span class="token number">1.81704600e-05</span> <span class="token number">2.76264545e-09</span>
  <span class="token number">8.59975898e-06</span> <span class="token number">3.23225287e-08</span> <span class="token number">6.01521315e-05</span> <span class="token number">1.01964176e-07</span>
  <span class="token number">8.37052448e-06</span> <span class="token number">3.09832138e-09</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
tf result<span class="token punctuation">:</span> tf<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">2.8023428e-09</span> <span class="token number">9.9990463e-01</span> <span class="token number">1.8170409e-05</span> <span class="token number">2.7626350e-09</span> <span class="token number">8.5997262e-06</span>
  <span class="token number">3.2322404e-08</span> <span class="token number">6.0152019e-05</span> <span class="token number">1.0196379e-07</span> <span class="token number">8.3704927e-06</span> <span class="token number">3.0983038e-09</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>float32<span class="token punctuation">)</span>
</code></pre>
<h3><a id="262_C_251"></a>2.6.2 C++接口</h3>
<pre><code class="prism language-cpp"><span class="token comment">// Load the model</span>
std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">&gt;</span> model <span class="token operator">=</span>
    tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">::</span><span class="token function">BuildFromFile</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Build the interpreter</span>
tflite<span class="token operator">::</span>ops<span class="token operator">::</span>builtin<span class="token operator">::</span>BuiltinOpResolver resolver<span class="token punctuation">;</span>
std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>Interpreter<span class="token operator">&gt;</span> interpreter<span class="token punctuation">;</span>
tflite<span class="token operator">::</span><span class="token function">InterpreterBuilder</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>interpreter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Resize input tensors, if desired.</span>
interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">AllocateTensors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span><span class="token operator">*</span> input <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_input_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Fill `input`.</span>

interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">float</span><span class="token operator">*</span> output <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_output_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1><a id="3_TensorFlow_Lite_273"></a>3 安装TensorFlow Lite</h1>
<h2><a id="31__274"></a>3.1 平台支持</h2>

<table>
<thead>
<tr>
<th>操作系统</th>
<th>iOS、Android、Linux</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>开发平台</strong></td>
<td>ARM64（支持RK3399）、Raspberry Pi、iOS</td>
</tr>
</tbody>
</table><h2><a id="32__279"></a>3.2 下载源代码</h2>
<p>到GitHub仓库下载2.0全部代码：</p>
<pre><code>wget https://github.com/tensorflow/tensorflow/archive/master.zip
</code></pre>
<p>解压后进入：</p>
<pre><code>unzip master.zip
cd ./tensorflow/lite/tools/make/
</code></pre>
<h2><a id="33__289"></a>3.3 安装依赖库</h2>
<h3><a id="331__290"></a>3.3.1 安装工具链</h3>
<pre><code>sudo apt-get install build-essential
</code></pre>
<h3><a id="332__294"></a>3.3.2 安装依赖库</h3>
<pre><code>./tensorflow/lite/tools/make/download_dependencies.sh
</code></pre>
<h2><a id="34_TensorFlow_Lite_298"></a>3.4 编译TensorFlow Lite</h2>
<p>在该目录下有多个**.lib**文件，根据运行环境进行编译：</p>
<pre><code># 在ARM64上运行：
bash ./tensorflow/lite/tools/make/build_aarch64_lib.sh
# 在普通Ubuntu上运行：
bash ./tensorflow/lite/tools/make/build_lib.sh
</code></pre>
<p>这会编译出一个静态库在：</p>
<pre><code>./tensorflow/lite/tools/make/gen/aarch64_armv8-a/lib/libtensorflow-lite.a
</code></pre>
<p>编译时可能会提示如下错误：</p>
<pre><code>/usr/bin/ld: 找不到 -lz collect2: error: ld returned 1 exit status
</code></pre>
<p>运行下列命令安装zlib：</p>
<pre><code>sudo apt-get install zlib1g-dev
</code></pre>
<h1><a id="4_TensorFlow_Lite_318"></a>4 TensorFlow Lite模型使用实例（分类模型）</h1>
<h2><a id="41_CLion_319"></a>4.1 新建CLion工程</h2>
<p>到（<a href="https://download.csdn.net/download/weixin_42499236/11892106">https://download.csdn.net/download/weixin_42499236/11892106</a>）下载该工程，解压后如下图所示：<br>
<img src="https://img-blog.csdnimg.cn/20191021190041635.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQ5OTIzNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2><a id="42_Cmakelist_323"></a>4.2 编写Cmakelist</h2>
<pre><code class="prism language-c"><span class="token function">cmake_minimum_required</span><span class="token punctuation">(</span>VERSION <span class="token number">3.15</span><span class="token punctuation">)</span>
<span class="token function">project</span><span class="token punctuation">(</span>testlite<span class="token punctuation">)</span>

<span class="token function">set</span><span class="token punctuation">(</span>CMAKE_CXX_STANDARD <span class="token number">14</span><span class="token punctuation">)</span>

<span class="token function">include_directories</span><span class="token punctuation">(</span><span class="token operator">/</span>home<span class="token operator">/</span>ai<span class="token operator">/</span>CLionProjects<span class="token operator">/</span>tensorflow<span class="token operator">-</span>master<span class="token operator">/</span><span class="token punctuation">)</span>
<span class="token function">include_directories</span><span class="token punctuation">(</span><span class="token operator">/</span>home<span class="token operator">/</span>ai<span class="token operator">/</span>CLionProjects<span class="token operator">/</span>tensorflow<span class="token operator">-</span>master<span class="token operator">/</span>tensorflow<span class="token operator">/</span>lite<span class="token operator">/</span>tools<span class="token operator">/</span>make<span class="token operator">/</span>downloads<span class="token operator">/</span>flatbuffers<span class="token operator">/</span>include<span class="token punctuation">)</span>
<span class="token function">include_directories</span><span class="token punctuation">(</span><span class="token operator">/</span>home<span class="token operator">/</span>ai<span class="token operator">/</span>CLionProjects<span class="token operator">/</span>tensorflow<span class="token operator">-</span>master<span class="token operator">/</span>tensorflow<span class="token operator">/</span>lite<span class="token operator">/</span>tools<span class="token operator">/</span>make<span class="token operator">/</span>downloads<span class="token operator">/</span>absl<span class="token punctuation">)</span>

<span class="token function">add_executable</span><span class="token punctuation">(</span>testlite main<span class="token punctuation">.</span>cpp bitmap_helpers<span class="token punctuation">.</span>cc utils<span class="token punctuation">.</span>cc<span class="token punctuation">)</span>

<span class="token function">target_link_libraries</span><span class="token punctuation">(</span>testlite <span class="token operator">/</span>home<span class="token operator">/</span>ai<span class="token operator">/</span>CLionProjects<span class="token operator">/</span>tensorflow<span class="token operator">-</span>master<span class="token operator">/</span>tensorflow<span class="token operator">/</span>lite<span class="token operator">/</span>tools<span class="token operator">/</span>make<span class="token operator">/</span>gen<span class="token operator">/</span>linux_x86_64<span class="token operator">/</span>lib<span class="token operator">/</span>libtensorflow<span class="token operator">-</span>lite<span class="token punctuation">.</span>a <span class="token operator">-</span>lpthread <span class="token operator">-</span>ldl <span class="token operator">-</span>lrt<span class="token punctuation">)</span>
</code></pre>
<h2><a id="43_maincpp_338"></a>4.3 编写main.cpp</h2>
<ul>
<li>导入头文件</li>
</ul>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span>      </span><span class="token comment">// NOLINT(build/include_order)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;getopt.h&gt;</span>     </span><span class="token comment">// NOLINT(build/include_order)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span>   </span><span class="token comment">// NOLINT(build/include_order)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span>  </span><span class="token comment">// NOLINT(build/include_order)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/uio.h&gt;</span>    </span><span class="token comment">// NOLINT(build/include_order)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span>     </span><span class="token comment">// NOLINT(build/include_order)</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdio&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;unordered_set&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"bitmap_helpers.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"get_top_n.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/model.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/kernels/register.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/optional_debug_tools.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/string_util.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/profiling/profiler.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/delegates/nnapi/nnapi_delegate.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"absl/memory/memory.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"utils.h"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
</code></pre>
<ul>
<li>调用GPU、NNAPI加速（若无GPU，则默认使用CPU）</li>
</ul>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">define</span> LOG(x) std::cerr</span>

<span class="token keyword">double</span> <span class="token function">get_us</span><span class="token punctuation">(</span><span class="token keyword">struct</span> timeval t<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> <span class="token number">1000000</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>tv_usec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">using</span> TfLiteDelegatePtr <span class="token operator">=</span> tflite<span class="token operator">::</span>Interpreter<span class="token operator">::</span>TfLiteDelegatePtr<span class="token punctuation">;</span>
<span class="token keyword">using</span> TfLiteDelegatePtrMap <span class="token operator">=</span> std<span class="token operator">::</span>map<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token punctuation">,</span> TfLiteDelegatePtr<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment">// 调用GPU</span>
TfLiteDelegatePtr <span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>Settings<span class="token operator">*</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(__ANDROID__)</span>
    TfLiteGpuDelegateOptionsV2 gpu_opts <span class="token operator">=</span> <span class="token function">TfLiteGpuDelegateOptionsV2Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gpu_opts<span class="token punctuation">.</span>inference_preference <span class="token operator">=</span>
      TFLITE_GPU_INFERENCE_PREFERENCE_SUSTAINED_SPEED<span class="token punctuation">;</span>
  gpu_opts<span class="token punctuation">.</span>is_precision_loss_allowed <span class="token operator">=</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>allow_fp16 <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> evaluation<span class="token operator">::</span><span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpu_opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">return</span> tflite<span class="token operator">::</span>evaluation<span class="token operator">::</span><span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

TfLiteDelegatePtrMap <span class="token function">GetDelegates</span><span class="token punctuation">(</span>tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>Settings<span class="token operator">*</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TfLiteDelegatePtrMap delegates<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>gl_backend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> delegate <span class="token operator">=</span> <span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"GPU acceleration is unsupported on this platform."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            delegates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token string">"GPU"</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>accel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> delegate <span class="token operator">=</span> tflite<span class="token operator">::</span>evaluation<span class="token operator">::</span><span class="token function">CreateNNAPIDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"NNAPI acceleration is unsupported on this platform."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            delegates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token string">"NNAPI"</span><span class="token punctuation">,</span> tflite<span class="token operator">::</span>evaluation<span class="token operator">::</span><span class="token function">CreateNNAPIDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> delegates<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>读取标签文件</li>
</ul>
<pre><code class="prism language-cpp">TfLiteStatus <span class="token function">ReadLabelsFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> file_name<span class="token punctuation">,</span>
                            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token operator">*</span> result<span class="token punctuation">,</span>
                            size_t<span class="token operator">*</span> found_label_count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>ifstream <span class="token function">file</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Labels file "</span> <span class="token operator">&lt;&lt;</span> file_name <span class="token operator">&lt;&lt;</span> <span class="token string">" not found\n"</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> kTfLiteError<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    string line<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">getline</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>found_label_count <span class="token operator">=</span> result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> padding <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> padding<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        result<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> kTfLiteOk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>打印模型节点信息</li>
</ul>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">PrintProfilingInfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> tflite<span class="token operator">::</span>profiling<span class="token operator">::</span>ProfileEvent<span class="token operator">*</span> e<span class="token punctuation">,</span>
                        <span class="token keyword">uint32_t</span> subgraph_index<span class="token punctuation">,</span> <span class="token keyword">uint32_t</span> op_index<span class="token punctuation">,</span>
                        TfLiteRegistration registration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// output something like</span>
    <span class="token comment">// time (ms) , Node xxx, OpCode xxx, symblic name</span>
    <span class="token comment">//      5.352, Node   5, OpCode   4, DEPTHWISE_CONV_2D</span>

    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>fixed <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setprecision</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>e<span class="token operator">-</span><span class="token operator">&gt;</span>end_timestamp_us <span class="token operator">-</span> e<span class="token operator">-</span><span class="token operator">&gt;</span>begin_timestamp_us<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000.0</span>
              <span class="token operator">&lt;&lt;</span> <span class="token string">", Subgraph "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setprecision</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> subgraph_index <span class="token operator">&lt;&lt;</span> <span class="token string">", Node "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setprecision</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> op_index <span class="token operator">&lt;&lt;</span> <span class="token string">", OpCode "</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setw</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span><span class="token function">setprecision</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> registration<span class="token punctuation">.</span>builtin_code <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span>
              <span class="token operator">&lt;&lt;</span> <span class="token function">EnumNameBuiltinOperator</span><span class="token punctuation">(</span>
                      <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>tflite<span class="token operator">::</span>BuiltinOperator<span class="token operator">&gt;</span><span class="token punctuation">(</span>registration<span class="token punctuation">.</span>builtin_code<span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>定义模型推理函数</li>
</ul>
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">RunInference</span><span class="token punctuation">(</span>tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>Settings<span class="token operator">*</span> s<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"no model file name\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 读取.tflite模型</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">&gt;</span> model<span class="token punctuation">;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>Interpreter<span class="token operator">&gt;</span> interpreter<span class="token punctuation">;</span>
    model <span class="token operator">=</span> tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">::</span><span class="token function">BuildFromFile</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nFailed to mmap model "</span> <span class="token operator">&lt;&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    s<span class="token operator">-</span><span class="token operator">&gt;</span>model <span class="token operator">=</span> model<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Loaded model "</span> <span class="token operator">&lt;&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    model<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">error_reporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"resolved reporter\n"</span><span class="token punctuation">;</span>
<span class="token comment">// 生成解释器</span>
    tflite<span class="token operator">::</span>ops<span class="token operator">::</span>builtin<span class="token operator">::</span>BuiltinOpResolver resolver<span class="token punctuation">;</span>

    tflite<span class="token operator">::</span><span class="token function">InterpreterBuilder</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>interpreter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>interpreter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to construct interpreter\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">UseNNAPI</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>old_accel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetAllowFp16PrecisionForFp32</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>allow_fp16<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印解释器参数，包括张量大小、输入节点名称等</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"tensors size: "</span> <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensors_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"nodes size: "</span> <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nodes_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"inputs: "</span> <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"input(0) name: "</span> <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetInputName</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> t_size <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensors_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> t_size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>name<span class="token punctuation">)</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> i <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>name <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span>
                          <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>bytes <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span>
                          <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>type <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span>
                          <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>params<span class="token punctuation">.</span>scale <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span>
                          <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>params<span class="token punctuation">.</span>zero_point <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_threads <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetNumThreads</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 定义输入图像参数</span>
    <span class="token keyword">int</span> image_width <span class="token operator">=</span> <span class="token number">224</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> image_height <span class="token operator">=</span> <span class="token number">224</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> image_channels <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">// 读取bmp图像</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span> in <span class="token operator">=</span> tflite<span class="token operator">::</span>label_image<span class="token operator">::</span><span class="token function">read_bmp</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>input_bmp_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>image_width<span class="token punctuation">,</span>
                                       <span class="token operator">&amp;</span>image_height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>image_channels<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> input <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span> <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"input: "</span> <span class="token operator">&lt;&lt;</span> input <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> inputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> outputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"number of inputs: "</span> <span class="token operator">&lt;&lt;</span> inputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"number of outputs: "</span> <span class="token operator">&lt;&lt;</span> outputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 创建图</span>
    <span class="token keyword">auto</span> delegates_ <span class="token operator">=</span> <span class="token function">GetDelegates</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> delegate <span class="token operator">:</span> delegates_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ModifyGraphWithDelegate</span><span class="token punctuation">(</span>delegate<span class="token punctuation">.</span>second<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
            kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to apply "</span> <span class="token operator">&lt;&lt;</span> delegate<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> <span class="token string">" delegate."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Applied "</span> <span class="token operator">&lt;&lt;</span> delegate<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> <span class="token string">" delegate."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">AllocateTensors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to allocate tensors!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span> <span class="token function">PrintInterpreterState</span><span class="token punctuation">(</span>interpreter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取输入张量元数据的维度等信息</span>
    TfLiteIntArray<span class="token operator">*</span> dims <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>dims<span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_height <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_width <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_channels <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 对图像进行resize</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> kTfLiteFloat32<span class="token operator">:</span>
            s<span class="token operator">-</span><span class="token operator">&gt;</span>input_floating <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>resize<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                          image_height<span class="token punctuation">,</span> image_width<span class="token punctuation">,</span> image_channels<span class="token punctuation">,</span> wanted_height<span class="token punctuation">,</span>
                          wanted_width<span class="token punctuation">,</span> wanted_channels<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kTfLiteUInt8<span class="token operator">:</span>
            tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>resize<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_tensor<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">,</span> in<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            image_height<span class="token punctuation">,</span> image_width<span class="token punctuation">,</span> image_channels<span class="token punctuation">,</span> wanted_height<span class="token punctuation">,</span>
                            wanted_width<span class="token punctuation">,</span> wanted_channels<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"cannot handle input type "</span>
                       <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>type <span class="token operator">&lt;&lt;</span> <span class="token string">" yet"</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 调用解释器</span>
    <span class="token keyword">auto</span> profiler <span class="token operator">=</span>
            absl<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>profiling<span class="token operator">::</span>Profiler<span class="token operator">&gt;</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>max_profiling_buffer_entries<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetProfiler</span><span class="token punctuation">(</span>profiler<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>profiling<span class="token punctuation">)</span> profiler<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">StartProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>loop_count <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_warmup_runs<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to invoke tflite!\n"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token comment">// 进行模型推理并计算运行时间</span>
    <span class="token keyword">struct</span> timeval start_time<span class="token punctuation">,</span> stop_time<span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_time<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>loop_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to invoke tflite!\n"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop_time<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"invoked \n"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"average time: "</span>
              <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">get_us</span><span class="token punctuation">(</span>stop_time<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">get_us</span><span class="token punctuation">(</span>start_time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>loop_count <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> <span class="token string">" ms \n"</span><span class="token punctuation">;</span>
<span class="token comment">// 打印运行事件</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>profiling<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        profiler<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">StopProfiling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> profile_events <span class="token operator">=</span> profiler<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">GetProfileEvents</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> profile_events<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">auto</span> subgraph_index <span class="token operator">=</span> profile_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>event_subgraph_index<span class="token punctuation">;</span>
            <span class="token keyword">auto</span> op_index <span class="token operator">=</span> profile_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>event_metadata<span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">auto</span> subgraph <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">subgraph</span><span class="token punctuation">(</span>subgraph_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">auto</span> node_and_registration <span class="token operator">=</span>
                    subgraph<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">node_and_registration</span><span class="token punctuation">(</span>op_index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> TfLiteRegistration registration <span class="token operator">=</span> node_and_registration<span class="token operator">-</span><span class="token operator">&gt;</span>second<span class="token punctuation">;</span>
            <span class="token function">PrintProfilingInfo</span><span class="token punctuation">(</span>profile_events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> subgraph_index<span class="token punctuation">,</span> op_index<span class="token punctuation">,</span>
                               registration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">float</span> threshold <span class="token operator">=</span> <span class="token number">0.001f</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>pair<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> top_results<span class="token punctuation">;</span>

<span class="token comment">// 获取Top-N结果</span>
    <span class="token keyword">int</span> output <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    TfLiteIntArray<span class="token operator">*</span> output_dims <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>dims<span class="token punctuation">;</span>
    <span class="token comment">// assume output dims to be something like (1, 1, ... ,size)</span>
    <span class="token keyword">auto</span> output_size <span class="token operator">=</span> output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> kTfLiteFloat32<span class="token operator">:</span>
            tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>get_top_n<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_output_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> output_size<span class="token punctuation">,</span>
                             s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_results<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span> <span class="token operator">&amp;</span>top_results<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> kTfLiteUInt8<span class="token operator">:</span>
            tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>get_top_n<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_output_tensor<span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               output_size<span class="token punctuation">,</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_results<span class="token punctuation">,</span> threshold<span class="token punctuation">,</span>
                               <span class="token operator">&amp;</span>top_results<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"cannot handle output type "</span>
                       <span class="token operator">&lt;&lt;</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>type <span class="token operator">&lt;&lt;</span> <span class="token string">" yet"</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> labels<span class="token punctuation">;</span>
    size_t label_count<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ReadLabelsFile</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>labels_file_name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>labels<span class="token punctuation">,</span> <span class="token operator">&amp;</span>label_count<span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 打印Top-N结果</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> result <span class="token operator">:</span> top_results<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span> confidence <span class="token operator">=</span> result<span class="token punctuation">.</span>first<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> index <span class="token operator">=</span> result<span class="token punctuation">.</span>second<span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> confidence <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> index <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> labels<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tflite<span class="token operator">::</span>label_image<span class="token operator">::</span>Settings s<span class="token punctuation">;</span>
    <span class="token function">RunInference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
<h2><a id="44__672"></a>4.4 下载预训练模型</h2>
<pre><code># Get model
curl https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_2018_02_22/mobilenet_v1_1.0_224.tgz | tar xzv -C /tmp

# Get labels
curl https://storage.googleapis.com/download.tensorflow.org/models/mobilenet_v1_1.0_224_frozen.tgz  | tar xzv -C /tmp  mobilenet_v1_1.0_224/labels.txt

mv /tmp/mobilenet_v1_1.0_224/labels.txt /tmp/
</code></pre>
<h2><a id="45__682"></a>4.5 修改模型配置</h2>
<p>在label_image.h中修改Settings：</p>
<pre><code class="prism language-cpp"><span class="token keyword">struct</span> Settings <span class="token punctuation">{</span>
  <span class="token keyword">bool</span> verbose <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> accel <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> old_accel <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> input_floating <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> profiling <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> allow_fp16 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> gl_backend <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> loop_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> input_mean <span class="token operator">=</span> <span class="token number">127.5f</span><span class="token punctuation">;</span>
  <span class="token keyword">float</span> input_std <span class="token operator">=</span> <span class="token number">127.5f</span><span class="token punctuation">;</span>
  string model_name <span class="token operator">=</span> <span class="token string">"/home/ai/CLionProjects/tflite/mobilenet_v1_1.0_224/mobilenet_v1_1.0_224.tflite"</span><span class="token punctuation">;</span>
  tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">*</span> model<span class="token punctuation">;</span>
  string input_bmp_name <span class="token operator">=</span> <span class="token string">"/home/ai/CLionProjects/tflite/grace_hopper.bmp"</span><span class="token punctuation">;</span>
  string labels_file_name <span class="token operator">=</span> <span class="token string">"/home/ai/CLionProjects/tflite/mobilenet_v1_1.0_224/labels.txt"</span><span class="token punctuation">;</span>
  string input_layer_type <span class="token operator">=</span> <span class="token string">"uint8_t"</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> number_of_threads <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> number_of_results <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> max_profiling_buffer_entries <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> number_of_warmup_runs <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h2><a id="46__707"></a>4.6 运行实例</h2>
<p>Top5分类结果输出如下：</p>
<pre><code>Loaded model /tmp/mobilenet_v1_1.0_224.tflite
resolved reporter
invoked
average time: 68.12 ms
0.860174: 653 653:military uniform
0.0481017: 907 907:Windsor tie
0.00786704: 466 466:bulletproof vest
0.00644932: 514 514:cornet, horn, trumpet, trump
0.00608029: 543 543:drumstick
</code></pre>
<p>结果显示该图像被正确分类，平均耗时68.12ms，速度非常快！</p>
<h1><a id="5_TensorFlow_LiteCPM_722"></a>5 TensorFlow Lite模型使用通用流程（以CPM算法为例）</h1>
<h2><a id="51__723"></a>5.1 流程示意</h2>
<div class="mermaid flow-chart"><svg height="582" version="1.1" width="206.921875" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="overflow: hidden; position: relative;" viewBox="0 0 206.921875 582" preserveAspectRatio="xMidYMid meet"><desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">Created with Raphaël 2.2.0</desc><defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><marker id="raphael-marker-endblock33-objvlxow" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-objo1cc6" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-objzh6p1" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-objgluyx" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-objleczh" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker><marker id="raphael-marker-endblock33-obj6ipgf" markerHeight="3" markerWidth="3" orient="auto" refX="1.5" refY="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"><use xlink:href="#raphael-marker-block" transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use></marker></defs><rect x="0" y="0" width="103.6875" height="36" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="st" transform="matrix(1,0,0,1,52.6172,4)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,52.6172,4)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">加载tflite模型</tspan></text><rect x="0" y="0" width="78" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op1" transform="matrix(1,0,0,1,65.4609,94)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op1t" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,65.4609,94)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">我的操作</tspan></text><rect x="0" y="0" width="117.25" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op2" transform="matrix(1,0,0,1,45.8359,184)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op2t" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,45.8359,184)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">加载所有tensor</tspan></text><rect x="0" y="0" width="186.921875" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op3" transform="matrix(1,0,0,1,11,274)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op3t" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,11,274)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">获取输入输出层tensor信息</tspan></text><rect x="0" y="0" width="199.921875" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op4" transform="matrix(1,0,0,1,4.5,364)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op4t" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,4.5,364)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">加载图像数据至输入tensor中</tspan></text><rect x="0" y="0" width="174.46875" height="36" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="op5" transform="matrix(1,0,0,1,17.2266,454)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="op5t" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,17.2266,454)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">调用invoke方法进行推理</tspan></text><rect x="0" y="0" width="200.921875" height="36" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="2" class="flowchart" id="e" transform="matrix(1,0,0,1,4,544)"></rect><text x="10" y="18" text-anchor="start" font-family="sans-serif" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="et" class="flowchartt" font-weight="normal" transform="matrix(1,0,0,1,4,544)" stroke-width="1"><tspan dy="5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">从输出tensor中取出推理结果</tspan></text><path fill="none" stroke="#000000" d="M104.4609375,40C104.4609375,40,104.4609375,79.65409994125366,104.4609375,91.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objvlxow)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M104.4609375,130C104.4609375,130,104.4609375,169.65409994125366,104.4609375,181.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objo1cc6)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M104.4609375,220C104.4609375,220,104.4609375,259.65409994125366,104.4609375,271.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objzh6p1)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M104.4609375,310C104.4609375,310,104.4609375,349.65409994125366,104.4609375,361.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objgluyx)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M104.4609375,400C104.4609375,400,104.4609375,439.65409994125366,104.4609375,451.00043908460066" stroke-width="2" marker-end="url(#raphael-marker-endblock33-objleczh)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path><path fill="none" stroke="#000000" d="M104.4609375,490C104.4609375,490,104.4609375,529.6540999412537,104.4609375,541.0004390846007" stroke-width="2" marker-end="url(#raphael-marker-endblock33-obj6ipgf)" font-family="sans-serif" font-weight="normal" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path></svg></div>
<h2><a id="52__735"></a>5.2 主要函数说明</h2>

<table>
<thead>
<tr>
<th align="center">函数方法</th>
<th align="center">作 用</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">tflite::FlatBufferModel::BuildFromFile(filename)</td>
<td align="center">加载tflite模型</td>
</tr>
<tr>
<td align="center">tflite::ops::builtin::BuiltinOpResolver resolver;</td>
<td align="center">生成resolver</td>
</tr>
<tr>
<td align="center">std::unique_ptr&lt;<a>tflite::Interpreter</a>&gt;interpreter;</td>
<td align="center">创建interpreter</td>
</tr>
<tr>
<td align="center">tflite::InterpreterBuilder(*model, resolver)(&amp;interpreter);</td>
<td align="center">生成interpreter</td>
</tr>
<tr>
<td align="center">interpreter-&gt;AllocateTensors();</td>
<td align="center">加载所有tensor</td>
</tr>
<tr>
<td align="center">float* input = interpreter-&gt;typed_input_tensor(0);</td>
<td align="center">取出输入tensor</td>
</tr>
<tr>
<td align="center">interpreter-&gt;Invoke();</td>
<td align="center">调用模型进行推理</td>
</tr>
<tr>
<td align="center">float* output = interpreter-&gt;typed_output_tensor(0);</td>
<td align="center">取出输出tensor</td>
</tr>
</tbody>
</table><h2><a id="53__747"></a>5.3 操作流程</h2>
<h3><a id="531_CPM_748"></a>5.3.1 CPM算法介绍</h3>
<p>CPM是一个关键点检测算法，示意图如下所示：<br>
<img src="https://img-blog.csdnimg.cn/20191101164303987.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQ5OTIzNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>
该示例中使用的模型使用6个stage，模型输出6个结果，每个结果的形状为（1，46，46，10），即返回10张46x46的概率图，分别预测10个点的位置。</p>
<h3><a id="532__753"></a>5.3.2 加载模型</h3>
<pre><code class="prism language-cpp"><span class="token comment">// load model file and build the interpreter.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"no model file name\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">&gt;</span> model<span class="token punctuation">;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>Interpreter<span class="token operator">&gt;</span> interpreter<span class="token punctuation">;</span>
    model <span class="token operator">=</span> tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">::</span><span class="token function">BuildFromFile</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nFailed to mmap model "</span> <span class="token operator">&lt;&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// invoke error reporter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{</span>
        model<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">error_reporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"resolved reporter\n"</span><span class="token punctuation">;</span>

    tflite<span class="token operator">::</span>ops<span class="token operator">::</span>builtin<span class="token operator">::</span>BuiltinOpResolver resolver<span class="token punctuation">;</span>

    tflite<span class="token operator">::</span><span class="token function">InterpreterBuilder</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>interpreter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>interpreter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to construct interpreter\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>在此段代码中，程序首先从s-&gt;model_name.c_str()读取tflite模型，然后创建interpreter，之后的所有操作都要基于interpreter中定义的方法进行。</p>
<h3><a id="533_tensor_786"></a>5.3.3 加载所有tensor</h3>
<pre><code class="prism language-cpp">    <span class="token comment">// allocate all of the tensors</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">AllocateTensors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to allocate tensors!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>上述代码会加载模型中所有定义的tensor，此步必须先执行，否则后续操作无效。</p>
<h3><a id="534__795"></a>5.3.4 获取输入输出信息</h3>
<pre><code class="prism language-cpp"><span class="token comment">// fetch the inputs' tensor and outputs' tensor</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> inputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> outputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// print the number of inputs and outputs.</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"number of inputs: "</span> <span class="token operator">&lt;&lt;</span> inputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"number of outputs: "</span> <span class="token operator">&lt;&lt;</span> outputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
</code></pre>
<p>调用interpreter中的inputs()、outputs()方法，获取模型输入、输出信息</p>
<h3><a id="535__806"></a>5.3.5 构建输入</h3>
<pre><code class="prism language-cpp"><span class="token keyword">int</span> input <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// get the dims of input tensor</span>
TfLiteIntArray<span class="token operator">*</span> dims <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>dims<span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_height <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_width <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_channels <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// fill input tensor with image data</span>
    std<span class="token operator">::</span>string imgpath <span class="token operator">=</span> <span class="token string">"/home/ai/Downloads/00010100000006E8-20190906-073144-359.jpg"</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Mat img <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">imread</span><span class="token punctuation">(</span>imgpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cols <span class="token operator">=</span> wanted_width<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rows <span class="token operator">=</span> wanted_height<span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Size dsize <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">Size</span><span class="token punctuation">(</span>cols<span class="token punctuation">,</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Mat img_rs<span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">resize</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> img_rs<span class="token punctuation">,</span> dsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img_rs<span class="token punctuation">,</span> img_rs<span class="token punctuation">,</span> cv<span class="token operator">::</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> img_inputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> img_rs<span class="token punctuation">.</span>cols <span class="token operator">*</span> img_rs<span class="token punctuation">.</span>rows <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        img_inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>  img_rs<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>typed_tensor方法会返回一个经过固定数据类型转换的tensor指针，使用opencv进行图像读取以及预处理，将其逐像素填充到输入tensor中</p>
<h3><a id="536__832"></a>5.3.6 调用模型</h3>
<pre><code class="prism language-cpp"><span class="token comment">// invoke the model to inference</span>
    <span class="token keyword">struct</span> timeval start_time<span class="token punctuation">,</span> stop_time<span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_time<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to invoke tflite!\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop_time<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"invoked \n"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"average time: "</span>
              <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">get_us</span><span class="token punctuation">(</span>stop_time<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">get_us</span><span class="token punctuation">(</span>start_time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>loop_count <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> <span class="token string">" ms \n"</span><span class="token punctuation">;</span>
</code></pre>
<p>调用invoke方法进行推理，并打印运行时间，调用一次invoke方法，即进行一次推理。</p>
<h3><a id="537__850"></a>5.3.7 取出输出结果</h3>
<pre><code class="prism language-cpp"><span class="token comment">// get the dims of outputs</span>
    <span class="token comment">// the index of line 175 depends on the which output you want.</span>
    <span class="token comment">// output = interpreter-&gt;outputs()[i];</span>
    <span class="token keyword">int</span> output <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    TfLiteIntArray<span class="token operator">*</span> output_dims <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>dims<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> output_size <span class="token operator">=</span> output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output dims"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        cout<span class="token operator">&lt;&lt;</span>output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// get outputs</span>
    <span class="token keyword">auto</span><span class="token operator">*</span> score_map <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_output_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>typed_output_tensor方法会返回模型的输出，index根据需求设置，此处有6个输出，只需要最后一个stage输出的结果，故设置index=5。</p>
<h3><a id="538__869"></a>5.3.8 输出结果后处理</h3>
<p>模型返回的结果会默认进行展平，形成一维数组，展平的顺序如下：<br>
<img src="https://img-blog.csdnimg.cn/2019110116544650.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQ5OTIzNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>
在该示例中需要返回10张46x46的概率图，处理程序如下：</p>
<pre><code class="prism language-cpp"><span class="token keyword">auto</span><span class="token operator">*</span> feature_map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">46</span><span class="token operator">*</span><span class="token number">46</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

cv<span class="token operator">::</span>Mat ori_img <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"/home/ai/Downloads/00010100000006E8-20190906-073144-359.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>j<span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">46</span><span class="token operator">*</span><span class="token number">46</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">+</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            feature_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>score_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cv<span class="token operator">::</span>Mat <span class="token function">feature_map_mat</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span>CV_32FC1<span class="token punctuation">,</span> feature_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> countMinVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> countMaxVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Point minPoint<span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Point maxPoint<span class="token punctuation">;</span>
        cv<span class="token operator">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>feature_map_mat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>countMinVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>countMaxVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minPoint<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" -- "</span> <span class="token operator">&lt;&lt;</span> maxPoint<span class="token punctuation">.</span>x  <span class="token operator">*</span> <span class="token number">1280</span><span class="token operator">/</span> <span class="token number">46</span>  <span class="token operator">&lt;&lt;</span> <span class="token string">" - "</span> <span class="token operator">&lt;&lt;</span> minPoint<span class="token punctuation">.</span>y  <span class="token operator">*</span> <span class="token number">720</span> <span class="token operator">/</span> <span class="token number">46</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> px <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>maxPoint<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> py <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>maxPoint<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token keyword">float</span> x <span class="token operator">=</span> px <span class="token operator">/</span> <span class="token number">46</span> <span class="token operator">*</span> <span class="token number">1280</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> y <span class="token operator">=</span> py <span class="token operator">/</span> <span class="token number">46</span> <span class="token operator">*</span> <span class="token number">720</span> <span class="token punctuation">;</span>
        <span class="token keyword">int</span> xx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> yy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>y<span class="token punctuation">;</span>

        cv<span class="token operator">::</span><span class="token function">circle</span><span class="token punctuation">(</span>ori_img<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span>xx<span class="token punctuation">,</span>yy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">-</span> j<span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">100</span> <span class="token operator">+</span> j<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> ori_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3><a id="538__905"></a>5.3.8 标记结果</h3>
<p>标记结果如下：<br>
<img src="https://img-blog.csdnimg.cn/20191101162058695.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjQ5OTIzNg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h3><a id="539__908"></a>5.3.9 完整程序</h3>
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span>   </span><span class="token comment">// NOLINT(build/include_order)</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/model.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/kernels/register.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/optional_debug_tools.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/string_util.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tensorflow/lite/profiling/profiler.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"settings.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"utils.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"opencv2/opencv.hpp"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> LOG(x) std::cerr</span>

<span class="token keyword">double</span> <span class="token function">get_us</span><span class="token punctuation">(</span><span class="token keyword">struct</span> timeval t<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span>tv_sec <span class="token operator">*</span> <span class="token number">1000000</span> <span class="token operator">+</span> t<span class="token punctuation">.</span>tv_usec<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

<span class="token keyword">using</span> TfLiteDelegatePtr <span class="token operator">=</span> tflite<span class="token operator">::</span>Interpreter<span class="token operator">::</span>TfLiteDelegatePtr<span class="token punctuation">;</span>
<span class="token keyword">using</span> TfLiteDelegatePtrMap <span class="token operator">=</span> std<span class="token operator">::</span>map<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token punctuation">,</span> TfLiteDelegatePtr<span class="token operator">&gt;</span><span class="token punctuation">;</span>

TfLiteDelegatePtr <span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>tflite<span class="token operator">::</span>cpm<span class="token operator">::</span>Settings<span class="token operator">*</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> defined(__ANDROID__)</span>
    TfLiteGpuDelegateOptionsV2 gpu_opts <span class="token operator">=</span> <span class="token function">TfLiteGpuDelegateOptionsV2Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  gpu_opts<span class="token punctuation">.</span>inference_preference <span class="token operator">=</span>
      TFLITE_GPU_INFERENCE_PREFERENCE_SUSTAINED_SPEED<span class="token punctuation">;</span>
  gpu_opts<span class="token punctuation">.</span>is_precision_loss_allowed <span class="token operator">=</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>allow_fp16 <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> evaluation<span class="token operator">::</span><span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpu_opts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">return</span> tflite<span class="token operator">::</span>evaluation<span class="token operator">::</span><span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span>

TfLiteDelegatePtrMap <span class="token function">GetDelegates</span><span class="token punctuation">(</span>tflite<span class="token operator">::</span>cpm<span class="token operator">::</span>Settings<span class="token operator">*</span> s<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    TfLiteDelegatePtrMap delegates<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>gl_backend<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> delegate <span class="token operator">=</span> <span class="token function">CreateGPUDelegate</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"GPU acceleration is unsupported on this platform."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            delegates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token string">"GPU"</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>accel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> delegate <span class="token operator">=</span> tflite<span class="token operator">::</span>evaluation<span class="token operator">::</span><span class="token function">CreateNNAPIDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>delegate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"NNAPI acceleration is unsupported on this platform."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            delegates<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span><span class="token string">"NNAPI"</span><span class="token punctuation">,</span> tflite<span class="token operator">::</span>evaluation<span class="token operator">::</span><span class="token function">CreateNNAPIDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> delegates<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">RunInference</span><span class="token punctuation">(</span>tflite<span class="token operator">::</span>cpm<span class="token operator">::</span>Settings<span class="token operator">*</span> s<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// load model file and build the interpreter.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"no model file name\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">&gt;</span> model<span class="token punctuation">;</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>tflite<span class="token operator">::</span>Interpreter<span class="token operator">&gt;</span> interpreter<span class="token punctuation">;</span>
    model <span class="token operator">=</span> tflite<span class="token operator">::</span>FlatBufferModel<span class="token operator">::</span><span class="token function">BuildFromFile</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\nFailed to mmap model "</span> <span class="token operator">&lt;&lt;</span> s<span class="token operator">-</span><span class="token operator">&gt;</span>model_name <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// invoke error reporter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span><span class="token punctuation">{</span>
        model<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">error_reporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"resolved reporter\n"</span><span class="token punctuation">;</span>

    tflite<span class="token operator">::</span>ops<span class="token operator">::</span>builtin<span class="token operator">::</span>BuiltinOpResolver resolver<span class="token punctuation">;</span>

    tflite<span class="token operator">::</span><span class="token function">InterpreterBuilder</span><span class="token punctuation">(</span><span class="token operator">*</span>model<span class="token punctuation">,</span> resolver<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>interpreter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>interpreter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to construct interpreter\n"</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// allocate all of the tensors</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">AllocateTensors</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to allocate tensors!"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// print the tensors which interpreter has got</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>verbose<span class="token punctuation">)</span> <span class="token function">PrintInterpreterState</span><span class="token punctuation">(</span>interpreter<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// invoke the NNAPI and set the computing precision</span>
    interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">UseNNAPI</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>old_accel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetAllowFp16PrecisionForFp32</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>allow_fp16<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If you have acceleration device, then load the graph into computing device</span>
    <span class="token keyword">auto</span> delegates_ <span class="token operator">=</span> <span class="token function">GetDelegates</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> delegate <span class="token operator">:</span> delegates_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ModifyGraphWithDelegate</span><span class="token punctuation">(</span>delegate<span class="token punctuation">.</span>second<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span>
            kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to apply "</span> <span class="token operator">&lt;&lt;</span> delegate<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> <span class="token string">" delegate."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Applied "</span> <span class="token operator">&lt;&lt;</span> delegate<span class="token punctuation">.</span>first <span class="token operator">&lt;&lt;</span> <span class="token string">" delegate."</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// set the number of threads</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_threads <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">SetNumThreads</span><span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>number_of_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// fetch the inputs' tensor and outputs' tensor</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> inputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> outputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// print the number of inputs and outputs.</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"number of inputs: "</span> <span class="token operator">&lt;&lt;</span> inputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"number of outputs: "</span> <span class="token operator">&lt;&lt;</span> outputs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

    <span class="token comment">// construct the input vector</span>
    <span class="token keyword">int</span> input <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">inputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    TfLiteIntArray<span class="token operator">*</span> dims <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>dims<span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_height <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_width <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> wanted_channels <span class="token operator">=</span> dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// fill input tensor with image data</span>
    std<span class="token operator">::</span>string imgpath <span class="token operator">=</span> <span class="token string">"/home/ai/Downloads/00010100000006E8-20190906-073144-359.jpg"</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Mat img <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">imread</span><span class="token punctuation">(</span>imgpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> cols <span class="token operator">=</span> wanted_width<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rows <span class="token operator">=</span> wanted_height<span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Size dsize <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">Size</span><span class="token punctuation">(</span>cols<span class="token punctuation">,</span> rows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Mat img_rs<span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">resize</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> img_rs<span class="token punctuation">,</span> dsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img_rs<span class="token punctuation">,</span> img_rs<span class="token punctuation">,</span> cv<span class="token operator">::</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> img_inputs <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> img_rs<span class="token punctuation">.</span>cols <span class="token operator">*</span> img_rs<span class="token punctuation">.</span>rows <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        img_inputs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>  img_rs<span class="token punctuation">.</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// invoke the model to inference</span>
    <span class="token keyword">struct</span> timeval start_time<span class="token punctuation">,</span> stop_time<span class="token punctuation">;</span>
    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_time<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> kTfLiteOk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to invoke tflite!\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">gettimeofday</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stop_time<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"invoked \n"</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"average time: "</span>
              <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span><span class="token function">get_us</span><span class="token punctuation">(</span>stop_time<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">get_us</span><span class="token punctuation">(</span>start_time<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>s<span class="token operator">-</span><span class="token operator">&gt;</span>loop_count <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
              <span class="token operator">&lt;&lt;</span> <span class="token string">" ms \n"</span><span class="token punctuation">;</span>

    <span class="token comment">// get the dims of outputs</span>
    <span class="token comment">// the index of line 175 depends on the which output you want.</span>
    <span class="token comment">// output = interpreter-&gt;outputs()[i];</span>
    <span class="token keyword">int</span> output <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">outputs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    TfLiteIntArray<span class="token operator">*</span> output_dims <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">tensor</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span>dims<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> output_size <span class="token operator">=</span> output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Output dims"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        cout<span class="token operator">&lt;&lt;</span>output_dims<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// get outputs</span>
    <span class="token keyword">auto</span><span class="token operator">*</span> score_map <span class="token operator">=</span> interpreter<span class="token operator">-</span><span class="token operator">&gt;</span>typed_output_tensor<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span><span class="token operator">*</span> feature_map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">float</span><span class="token punctuation">[</span><span class="token number">46</span><span class="token operator">*</span><span class="token number">46</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    cv<span class="token operator">::</span>Mat ori_img <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"/home/ai/Downloads/00010100000006E8-20190906-073144-359.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>j<span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">46</span><span class="token operator">*</span><span class="token number">46</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span>i<span class="token operator">+</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            feature_map<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>score_map<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            index<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cv<span class="token operator">::</span>Mat <span class="token function">feature_map_mat</span><span class="token punctuation">(</span><span class="token number">46</span><span class="token punctuation">,</span><span class="token number">46</span><span class="token punctuation">,</span>CV_32FC1<span class="token punctuation">,</span> feature_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> countMinVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> countMaxVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Point minPoint<span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Point maxPoint<span class="token punctuation">;</span>
        cv<span class="token operator">::</span><span class="token function">minMaxLoc</span><span class="token punctuation">(</span>feature_map_mat<span class="token punctuation">,</span> <span class="token operator">&amp;</span>countMinVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>countMaxVal<span class="token punctuation">,</span> <span class="token operator">&amp;</span>minPoint<span class="token punctuation">,</span> <span class="token operator">&amp;</span>maxPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        cout <span class="token operator">&lt;&lt;</span> <span class="token string">" -- "</span> <span class="token operator">&lt;&lt;</span> maxPoint<span class="token punctuation">.</span>x  <span class="token operator">*</span> <span class="token number">1280</span><span class="token operator">/</span> <span class="token number">46</span>  <span class="token operator">&lt;&lt;</span> <span class="token string">" - "</span> <span class="token operator">&lt;&lt;</span> minPoint<span class="token punctuation">.</span>y  <span class="token operator">*</span> <span class="token number">720</span> <span class="token operator">/</span> <span class="token number">46</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

        <span class="token keyword">auto</span> px <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>maxPoint<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> py <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span>maxPoint<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token keyword">float</span> x <span class="token operator">=</span> px <span class="token operator">/</span> <span class="token number">46</span> <span class="token operator">*</span> <span class="token number">1280</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> y <span class="token operator">=</span> py <span class="token operator">/</span> <span class="token number">46</span> <span class="token operator">*</span> <span class="token number">720</span> <span class="token punctuation">;</span>
        <span class="token keyword">int</span> xx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>x<span class="token punctuation">;</span>
        <span class="token keyword">int</span> yy <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>y<span class="token punctuation">;</span>

        cv<span class="token operator">::</span><span class="token function">circle</span><span class="token punctuation">(</span>ori_img<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span>xx<span class="token punctuation">,</span>yy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span> <span class="token operator">-</span> j<span class="token operator">*</span> <span class="token number">20</span><span class="token punctuation">,</span><span class="token number">100</span> <span class="token operator">+</span> j<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> ori_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tflite<span class="token operator">::</span>cpm<span class="token operator">::</span>Settings s<span class="token punctuation">;</span>
    <span class="token function">RunInference</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
</div>
</body>

</html>
